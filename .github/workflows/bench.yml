name: Bench

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  bench:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install
        run: |
          python -m pip install -U pip
          pip install -e ".[dev]"

      - name: Run bench
        run: |
          set -euxo pipefail
          mkdir -p results
          python scripts/bench_scan.py

          echo "---- bench_scan.json ----"
          cat results/bench_scan.json

          python - <<'PY'
          import json, os
          p = "results/bench_scan.json"
          d = json.load(open(p))
          line = f"MH/s={d['mhps']:.3f}  trials={d['trials']}  sec={d['seconds']:.3f}  py={d.get('python','?')}"
          print("BENCH:", line)
          summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if summary:
              with open(summary, "a") as f:
                  f.write("## VIREON Bench Summary\n")
                  f.write(f"- {line}\n")
          PY

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: vireon-bench-results
          path: results/
